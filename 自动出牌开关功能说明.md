# TheDecree 自动出牌开关功能说明

## 📋 功能概述

为 TheDecree 游戏模式添加了一个**自动出牌开关**，允许玩家（player_0）在"自动出牌"和"手动出牌"之间切换。

- **自动出牌模式（默认）**：系统自动为 player_0 叫牌和选牌
- **手动出牌模式**：player_0 需要手动完成叫牌和选牌操作

## 🎯 实现效果

### 开关状态
- **开启（绿色）**："自动出牌: 开" - player_0 自动执行所有操作
- **关闭（红色）**："自动出牌: 关" - player_0 需要手动操作

### 手动操作流程

当开关关闭时，player_0 需要：

1. **庄家叫牌阶段**（如果 player_0 是庄家）：
   - 点击"1"、"2"或"3"按钮，宣布本回合出牌数量

2. **选牌出牌阶段**：
   - 点击手牌选择卡牌（向上移动表示已选中）
   - 点击"出牌"按钮提交选择

## 📁 修改的文件

### 1. TheDecreeMode.ts

**新增字段**：
```typescript
// 第 68 行
private isPlayer0AutoPlay: boolean = true;  // 默认开启自动出牌
```

**修改方法**：

#### `autoDealerCall()` (第 946-976 行)
```typescript
private autoDealerCall(): void {
    if (!this.currentRound) return;

    const dealerId = this.currentRound.dealerId;

    // 跳过 player_0 的自动出牌（如果开关关闭）
    if (dealerId === 'player_0' && !this.isPlayer0AutoPlay) {
        console.log('[TheDecree] Waiting for player_0 to manually call...');
        return;
    }

    // AI 叫牌逻辑...
}
```

#### `autoPlayerSelection()` (第 981-1012 行)
```typescript
private autoPlayerSelection(): void {
    // ...
    for (const playerId of playerOrder) {
        const player = this.playerManager.getPlayer(playerId) as TheDecreePlayer;
        if (!player || player.hasPlayed) continue;

        // 跳过 player_0 的自动出牌（如果开关关闭）
        if (playerId === 'player_0' && !this.isPlayer0AutoPlay) {
            console.log('[TheDecree] Waiting for player_0 to manually select cards...');
            continue;
        }

        // AI 选牌逻辑...
    }
}
```

**新增公开方法** (第 857-872 行)：
```typescript
/**
 * 获取 player_0 的自动出牌开关状态
 */
public isPlayer0AutoPlayEnabled(): boolean {
    return this.isPlayer0AutoPlay;
}

/**
 * 设置 player_0 的自动出牌开关状态
 */
public setPlayer0AutoPlay(enabled: boolean): void {
    this.isPlayer0AutoPlay = enabled;
    console.log(`[TheDecree] Player_0 auto-play ${enabled ? 'enabled' : 'disabled'}`);
}
```

---

### 2. TheDecreeUIController.ts

**新增字段** (第 23-30 行)：
```typescript
@property(Button)
public autoPlayToggleButton: Button | null = null;

private autoPlayToggleLabel: Label | null = null;
```

**修改 `autoFindUIElements()`** (第 145-153 行)：
```typescript
// 自动查找开关按钮
if (!this.autoPlayToggleButton) {
    const toggleNode = this.node.getChildByName('AutoPlayToggleButton');
    this.autoPlayToggleButton = toggleNode?.getComponent(Button) || null;
    if (this.autoPlayToggleButton) {
        const labelNode = toggleNode?.getChildByName('Label');
        this.autoPlayToggleLabel = labelNode?.getComponent(Label) || null;
    }
}
```

**修改 `registerButtonEvents()`** (第 214-216 行)：
```typescript
if (this.autoPlayToggleButton) {
    this.autoPlayToggleButton.node.on(Button.EventType.CLICK, this.onAutoPlayToggleClicked, this);
}
```

**新增方法**：

#### `onAutoPlayToggleClicked()` (第 350-364 行)
```typescript
/**
 * 处理开关按钮点击事件
 */
private onAutoPlayToggleClicked(): void {
    if (!this._game || !this._game.theDecreeMode) {
        console.error('[TheDecreeUI] Cannot toggle auto-play - game not ready');
        return;
    }

    const theDecreeMode = this._game.theDecreeMode;
    const currentState = theDecreeMode.isPlayer0AutoPlayEnabled();
    const newState = !currentState;

    theDecreeMode.setPlayer0AutoPlay(newState);
    this.updateAutoPlayToggleUI(newState);

    console.log(`[TheDecreeUI] Auto-play toggled to: ${newState ? 'ON' : 'OFF'}`);
}
```

#### `updateAutoPlayToggleUI()` (第 369-386 行)
```typescript
/**
 * 更新开关按钮的视觉状态
 */
private updateAutoPlayToggleUI(isEnabled: boolean): void {
    if (!this.autoPlayToggleButton || !this.autoPlayToggleLabel) {
        return;
    }

    // 更新文字
    this.autoPlayToggleLabel.string = isEnabled ? '自动出牌: 开' : '自动出牌: 关';

    // 更新颜色（绿色=开启，红色=关闭）
    const targetNode = this.autoPlayToggleButton.node.getChildByName('Background');
    if (targetNode) {
        const sprite = targetNode.getComponent('cc.Sprite');
        if (sprite) {
            (sprite as any).color = isEnabled ? new Color(100, 200, 100) : new Color(200, 100, 100);
        }
    }
}
```

**修改 `start()`** (第 75-81 行)：
```typescript
// 初始化开关 UI 状态
this.scheduleOnce(() => {
    if (this._game && this._game.theDecreeMode) {
        const isEnabled = this._game.theDecreeMode.isPlayer0AutoPlayEnabled();
        this.updateAutoPlayToggleUI(isEnabled);
    }
}, 0.1);
```

---

## 🎨 UI 设置指南

### 在 Cocos Creator 中创建开关按钮

1. **创建按钮节点**
   - 在 `ObjectTheDecreeNode` 下创建一个新的 `Button` 节点
   - 命名为：`AutoPlayToggleButton`

2. **按钮结构**
   ```
   AutoPlayToggleButton (Button)
   ├── Background (Sprite)  ← 背景色，用于显示开/关状态
   └── Label (Label)        ← 文字"自动出牌: 开/关"
   ```

3. **节点属性设置**
   - **Position**：建议放置在屏幕左上角或右上角
   - **Size**：建议 150x50 像素
   - **Background Sprite**：纯色或圆角矩形
   - **Label Font Size**：16-18
   - **Label Color**：白色 (255, 255, 255)

4. **在编辑器中绑定**（可选）
   - 选中 `ObjectTheDecreeNode`
   - 找到 `TheDecreeUIController` 组件
   - 将 `AutoPlayToggleButton` 拖拽到 `Auto Play Toggle Button` 属性槽

### 推荐布局

```
屏幕顶部
┌─────────────────────────────────────────────┐
│  [自动出牌: 开]                             │  ← AutoPlayToggleButton
│                                             │
│                公共牌                        │
│          [🂡][🂢][🂣][🂤]                   │
│                                             │
│                                             │
│          [玩家 1]  [玩家 2]                  │
│                                             │
│    [1] [2] [3]  [出牌]  ← 叫牌按钮 & 出牌按钮│
│                                             │
│        [我的手牌: 🂡🂢🂣🂤🂥]                  │
└─────────────────────────────────────────────┘
```

---

## 🔄 执行流程

### 自动出牌模式（开关开启）

```
1. 游戏开始
   ↓
2. TheDecreeMode.update() 每帧检查游戏状态
   ↓
3. GameState.DEALER_CALL
   - 调用 autoDealerCall()
   - 自动为所有玩家（包括 player_0）叫牌
   ↓
4. GameState.PLAYER_SELECTION
   - 调用 autoPlayerSelection()
   - 自动为所有玩家（包括 player_0）选牌并出牌
   ↓
5. 进入 ShowDown、Scoring、Refill 阶段
```

### 手动出牌模式（开关关闭）

```
1. 游戏开始，玩家点击开关按钮
   - onAutoPlayToggleClicked()
   - setPlayer0AutoPlay(false)
   - 更新按钮显示为"自动出牌: 关"（红色）
   ↓
2. GameState.DEALER_CALL（如果 player_0 是庄家）
   - autoDealerCall() 检测到 player_0 且开关关闭
   - 跳过自动叫牌，等待手动操作
   - 显示叫牌按钮 [1] [2] [3]
   - 玩家点击按钮 → onCallButtonClicked()
   ↓
3. GameState.PLAYER_SELECTION
   - autoPlayerSelection() 跳过 player_0
   - player_0 手动点击卡牌选择
   - 点击"出牌"按钮 → onPlayButtonClicked()
   ↓
4. 其他 AI 玩家自动完成出牌
   ↓
5. 进入 ShowDown、Scoring、Refill 阶段
```

---

## 🧪 测试方法

### 1. 启动游戏
在 Cocos Creator 中运行游戏，选择 TheDecree 模式。

### 2. 测试自动模式（默认）
- 观察游戏是否自动进行
- player_0 应该自动叫牌和出牌
- 控制台不应出现"Waiting for player_0 to manually..."日志

### 3. 测试手动模式
- 点击"自动出牌"开关按钮
- 按钮文字变为"自动出牌: 关"，背景变红
- **如果 player_0 是庄家**：
  - 观察是否显示 [1] [2] [3] 叫牌按钮
  - 点击任意按钮，确认叫牌成功
  - 控制台应显示：`[TheDecree] Waiting for player_0 to manually call...`
- **选牌阶段**：
  - 点击手牌选择卡牌（卡牌应向上移动）
  - 点击"出牌"按钮
  - 确认出牌成功
  - 控制台应显示：`[TheDecree] Waiting for player_0 to manually select cards...`

### 4. 测试开关切换
- 在游戏进行中多次点击开关
- 观察按钮颜色和文字是否正确变化
- 绿色 = 开启，红色 = 关闭

---

## 🐛 常见问题

### Q: 开关按钮不显示
**A:** 检查以下几点：
1. 确保在 Cocos Creator 场景中创建了 `AutoPlayToggleButton` 节点
2. 节点命名必须完全一致
3. 检查节点是否在 `ObjectTheDecreeNode` 下
4. 检查 `Button` 和 `Label` 组件是否正确添加

### Q: 点击开关没有反应
**A:** 检查：
1. 控制台是否有错误日志
2. `TheDecreeUIController` 是否正确绑定到 `ObjectTheDecreeNode`
3. `Game.theDecreeMode` 是否已初始化

### Q: 关闭自动出牌后，其他玩家也不出牌了
**A:** 这不应该发生，检查 `autoPlayerSelection()` 中的逻辑：
```typescript
// 应该只跳过 player_0
if (playerId === 'player_0' && !this.isPlayer0AutoPlay) {
    continue;
}
```

### Q: 手动模式下，叫牌按钮不显示
**A:** 检查：
1. `updateCallButtonsVisibility()` 是否正确判断 player_0 是庄家
2. `GameState` 是否为 `DEALER_CALL`
3. 控制台日志：`[TheDecreeUI] updateCallButtonsVisibility() called`

### Q: 叫牌按钮点击没有反应
**A:** 这个问题已在 v1.1 版本中修复：
- **原因**：`autoDealerCall()` 每 2 秒重复调用，但返回后仍重置计时器
- **修复**：修改 `autoDealerCall()` 返回布尔值，只在成功执行时重置计时器
- **位置**：[TheDecreeMode.ts:967-998](poker_arena_client/assets/Scripts/Core/GameMode/TheDecreeMode.ts#L967-L998)

```typescript
// 修复后的代码
case GameState.DEALER_CALL:
    if (this.stateTimer >= this.STATE_DELAY) {
        // 只在自动叫牌成功执行时重置计时器
        const executed = this.autoDealerCall();
        if (executed) {
            this.stateTimer = 0;
        }
    }
    break;
```

---

## 📝 控制台日志

### 正常日志示例

**开关切换**：
```
[TheDecreeUI] Auto-play toggled to: OFF
[TheDecree] Player_0 auto-play disabled
```

**手动叫牌等待**：
```
[TheDecree] Waiting for player_0 to manually call...
[TheDecreeUI] Call 2 button clicked
[TheDecreeUI] Dealer called: 2 cards
```

**手动选牌等待**：
```
[TheDecree] Waiting for player_0 to manually select cards...
[TheDecreeUI] Selected cards: [0, 1]
[TheDecreeUI] Play button clicked
[TheDecreeUI] Cards played successfully
```

---

## 🎯 后续优化建议

1. **持久化设置**
   - 将开关状态保存到 LocalStorage
   - 游戏启动时恢复用户上次的选择

2. **快捷键支持**
   - 添加键盘快捷键（如 Space 键）切换开关

3. **UI 动画**
   - 开关切换时添加平滑的颜色过渡动画
   - 使用 tween 动画增强视觉效果

4. **提示文本**
   - 手动模式下，显示"请选择 X 张牌"提示
   - 超时提示（可选）

5. **禁用状态**
   - 在 ShowDown、Scoring 等阶段禁用开关按钮
   - 避免玩家在不适当的时机切换

---

## 📊 代码统计

| 文件 | 新增行数 | 修改行数 | 功能 |
|------|---------|---------|------|
| TheDecreeMode.ts | 20 | 10 | 核心逻辑 |
| TheDecreeUIController.ts | 70 | 15 | UI 控制 |

**总计**：约 115 行新增/修改代码

---

**实现日期**：2025-12-25
**开发者**：Claude Code
**版本**：v1.1 (修复叫牌按钮问题)
