# 手动选牌功能修复说明 (v1.2)

## 🐛 修复的问题

### 问题 1: 玩家无法手动选牌
**现象**：关闭自动出牌后，player_0 的手牌无法点击选择

**原因**：
1. `enableCardSelection()` 在游戏开始时就被调用（2秒后），但此时游戏还未进入 `PLAYER_SELECTION` 状态
2. 当游戏进入 `PLAYER_SELECTION` 状态时，没有再次启用卡牌选择
3. 如果 player_0 不是庄家，叫牌按钮不会出现，`enableCardSelection()` 也不会被触发

**解决方案**：
1. 移除 `start()` 方法中的自动启用逻辑
2. 在 `dealerCall()` 方法中（进入 `PLAYER_SELECTION` 状态时）调用 `enableCardSelectionIfNeeded()`
3. 新增 `enableCardSelectionIfNeeded()` 方法通知 UI 启用卡牌选择
4. 将 `TheDecreeUIController.enableCardSelection()` 从 `private` 改为 `public`

---

### 问题 2: 其他玩家的牌在 player_0 出牌前就展示了
**现象**：关闭自动出牌后，AI 玩家在 2 秒后自动出牌，但 player_0 还没出牌

**原因**：
1. `update()` 方法中的 `PLAYER_SELECTION` 状态每 2 秒就会调用 `autoPlayerSelection()`
2. AI 玩家会立即出牌，导致只剩 player_0 未出牌
3. 虽然游戏保持在 `PLAYER_SELECTION` 状态，但 AI 的牌已经被打出并可能展示

**解决方案**：
1. 在 `RoundState` 接口中添加 `aiPlayersAutoPlayed: boolean` 字段
2. 修改 `update()` 中的 `PLAYER_SELECTION` 逻辑，只在第一次达到延迟时执行 AI 出牌
3. 执行后设置 `aiPlayersAutoPlayed = true`，防止重复执行
4. 修改 `autoPlayerSelection()` 返回 `boolean`，表示是否有 AI 玩家出牌

---

## 📝 修改的文件

### 1. TheDecreeMode.ts

#### 修改 RoundState 接口 (第 16-25 行)
```typescript
interface RoundState {
    roundNumber: number;
    dealerId: string;
    cardsToPlay: number;
    playerPlays: Map<string, number[]>;
    roundWinnerId: string | null;
    roundLoserId: string | null;
    handResults: Map<string, TexasHandResult> | null;
    aiPlayersAutoPlayed: boolean;  // 新增：AI 玩家是否已自动出牌
}
```

#### 修改 startNewRound() (第 527-535 行)
```typescript
public startNewRound(dealerId: string): void {
    this.currentRound = {
        roundNumber: (this.currentRound?.roundNumber || 0) + 1,
        dealerId,
        cardsToPlay: 0,
        playerPlays: new Map(),
        roundWinnerId: null,
        roundLoserId: null,
        handResults: null,
        aiPlayersAutoPlayed: false  // 初始化为 false
    };
    // ...
}
```

#### 修改 update() 状态机 (第 176-187 行)
```typescript
case GameState.PLAYER_SELECTION:
    if (this.stateTimer >= this.STATE_DELAY) {
        // 只在第一次执行 AI 出牌
        if (this.currentRound && !this.currentRound.aiPlayersAutoPlayed) {
            const anyAIPlayed = this.autoPlayerSelection();
            if (anyAIPlayed) {
                this.currentRound.aiPlayersAutoPlayed = true;
            }
            this.stateTimer = 0;
        }
    }
    break;
```

#### 新增 enableCardSelectionIfNeeded() 方法 (第 509-522 行)
```typescript
/**
 * Enable card selection for player_0 if needed
 * Notifies TheDecreeUIController to enable card selection when in manual mode
 */
private enableCardSelectionIfNeeded(): void {
    if (!this.game.objectsTheDecreeNode) return;

    const uiController = this.game.objectsTheDecreeNode.getComponent('TheDecreeUIController') as any;
    if (uiController && typeof uiController.enableCardSelection === 'function') {
        uiController.enableCardSelection();
        console.log('[TheDecree] Card selection enabled for player_0');
    }
}
```

#### 修改 dealerCall() (第 562-576 行)
```typescript
public dealerCall(cardsToPlay: 1 | 2 | 3): boolean {
    if (!this.currentRound) return false;
    if (this.state !== GameState.DEALER_CALL) return false;

    this.currentRound.cardsToPlay = cardsToPlay;
    this.state = GameState.PLAYER_SELECTION;

    this.updateUICallButtonsVisibility();

    // 新增：启用卡牌选择
    this.enableCardSelectionIfNeeded();

    return true;
}
```

#### 修改 autoPlayerSelection() (第 1004-1039 行)
```typescript
/**
 * 自动所有玩家选牌（AI决策）
 * @returns {boolean} 是否有AI玩家执行了自动出牌
 */
private autoPlayerSelection(): boolean {
    if (!this.currentRound) return false;

    const cardsToPlay = this.currentRound.cardsToPlay;
    const playerOrder = this.playerManager.getPlayerOrder();
    let anyAIPlayed = false;  // 新增：追踪是否有 AI 出牌

    for (const playerId of playerOrder) {
        const player = this.playerManager.getPlayer(playerId) as TheDecreePlayer;
        if (!player || player.hasPlayed) continue;

        if (playerId === 'player_0' && !this.isPlayer0AutoPlay) {
            console.log('[TheDecree] Waiting for player_0 to manually select cards...');
            continue;
        }

        const selectedCards = player.handCards.slice(0, cardsToPlay);

        if (selectedCards.length === cardsToPlay) {
            this.playCards(selectedCards, playerId);
            anyAIPlayed = true;  // 标记有 AI 出牌
            // ...
        }
    }

    return anyAIPlayed;
}
```

---

### 2. TheDecreeUIController.ts

#### 修改 start() (第 66-77 行)
```typescript
start() {
    // 移除了自动启用卡牌选择的逻辑
    // this.scheduleOnce(() => {
    //     this.enableCardSelection();
    // }, 2);

    // Initialize button visibility
    this.updateCallButtonsVisibility();

    // Initialize auto-play toggle UI
    this.scheduleOnce(() => {
        if (this._game && this._game.theDecreeMode) {
            const isEnabled = this._game.theDecreeMode.isPlayer0AutoPlayEnabled();
            this.updateAutoPlayToggleUI(isEnabled);
        }
    }, 0.1);
}
```

#### 修改 enableCardSelection() 可见性 (第 239-255 行)
```typescript
/**
 * Enable card selection for player 0
 * Can be called externally by TheDecreeMode
 */
public enableCardSelection(): void {  // 从 private 改为 public
    if (!this._game || !this._game.handsManager) {
        console.error('[TheDecreeUI] Cannot enable card selection - game not ready');
        return;
    }

    this._game.handsManager.enableCardSelection(0, (selectedIndices: number[]) => {
        this._selectedCardIndices = selectedIndices;
        this.onSelectionChanged(selectedIndices);
    });

    console.log('[TheDecreeUI] Card selection enabled');
}
```

---

## 🔄 执行流程（修复后）

### 手动模式下的完整流程

```
1. 玩家关闭自动出牌开关
   ↓
2. 游戏进入 DEALER_CALL 状态
   - 如果 player_0 是庄家，显示叫牌按钮
   ↓
3. player_0 点击叫牌按钮（1/2/3）
   - dealerCall() 被调用
   - 状态改为 PLAYER_SELECTION
   - enableCardSelectionIfNeeded() 启用卡牌选择 ✅
   ↓
4. 2 秒后，AI 玩家自动出牌（仅一次）
   - autoPlayerSelection() 返回 true
   - aiPlayersAutoPlayed 设为 true ✅
   - stateTimer 重置为 0
   ↓
5. player_0 现在可以点击手牌选择 ✅
   - 卡牌向上移动表示选中
   - 选择足够数量的牌后，"出牌"按钮启用
   ↓
6. player_0 点击"出牌"按钮
   - playCards() 被调用
   - allPlayersPlayed() 返回 true
   - 游戏进入 SHOWDOWN 状态
   ↓
7. 所有玩家的牌型展示 ✅
```

---

## 🧪 测试步骤

1. **启动游戏并关闭自动出牌**
   - 点击"自动出牌"开关，变为红色"自动出牌: 关"

2. **测试庄家叫牌**（如果 player_0 是庄家）
   - 观察是否显示 [1] [2] [3] 按钮
   - 点击任意按钮，确认叫牌成功
   - 控制台应显示：`[TheDecree] Card selection enabled for player_0`

3. **测试手动选牌**
   - 等待 2 秒，AI 玩家自动出牌
   - 点击 player_0 的手牌
   - 观察卡牌是否向上移动（表示选中）
   - 选择正确数量的牌

4. **测试出牌**
   - 点击"出牌"按钮
   - 确认出牌成功
   - 观察是否所有玩家出牌后才进入 ShowDown

5. **检查控制台日志**
   ```
   [TheDecree] Card selection enabled for player_0
   [TheDecreeUI] Card selection enabled
   [TheDecreeUI] Selected cards: [0, 1]
   [TheDecreeUI] Play button clicked
   [TheDecreeUI] Cards played successfully
   ```

---

## 📊 版本历史

- **v1.0**: 初始实现自动出牌开关
- **v1.1**: 修复叫牌按钮点击无反应问题
- **v1.2**: 修复手动选牌功能 + AI 提前出牌问题 ✅

---

**修复日期**：2025-12-25
**开发者**：Claude Code
**版本**：v1.2
